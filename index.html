<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfriPulse AI Weekly Digest</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
    <!--
        NOTE: The global JavaScript variables __firebase_config, __app_id, and __initial_auth_token 
        are expected to be provided by the hosting environment (like Canvas or Firebase Hosting's integration).
    -->
    <script>
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Use a consistent app ID for Firestore paths
        const appId = 'afripulse-ai-digest'; 

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Data fetching may fail.");
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">
        
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-gray-900 tracking-tighter">AfriPulse AI</h1>
            <p class="mt-2 text-xl text-indigo-700 font-semibold">Africa Startup & VC Weekly Digest</p>
            <p class="mt-3 text-gray-500 max-w-lg mx-auto">Get the top 10 most relevant funding and tech stories across Africa, summarized by AI and delivered every week.</p>
        </header>

        <!-- Subscription Form -->
        <div id="subscription-section" class="mb-12 p-6 bg-indigo-50 border-t-4 border-indigo-500 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Weekly Delivery
            </h2>
            <form id="subscribe-form" class="flex flex-col sm:flex-row gap-4">
                <input 
                    type="email" 
                    id="email-input"
                    placeholder="name@example.com"
                    required
                    class="flex-grow p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner text-gray-700"
                >
                <button 
                    type="submit" 
                    id="subscribe-button"
                    class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md flex-shrink-0"
                >
                    Subscribe Now
                </button>
            </form>
            <p id="message-box" class="mt-3 text-sm text-center font-medium"></p>
        </div>

        <!-- Latest Digest Title and Loader -->
        <div class="mb-8">
            <h2 id="digest-title" class="text-4xl font-extrabold text-gray-800">Latest Digest</h2>
            <p id="digest-date" class="text-gray-500 mt-2"></p>
            <div id="loading-spinner" class="mt-6 text-center flex flex-col items-center hidden">
                <div class="inline-block h-10 w-10 animate-spin rounded-full border-4 border-solid border-indigo-500 border-r-transparent" role="status"></div>
                <p class="mt-3 text-indigo-600 font-medium">Fetching today's top stories...</p>
            </div>
            <p id="error-message" class="text-red-500 bg-red-100 p-3 rounded-lg mt-4 hidden">Could not load the latest digest.</p>
        </div>

        <!-- Stories Container -->
        <div id="stories-container" class="space-y-8">
            <!-- Stories will be injected here -->
        </div>

    </div>

    <!-- Firebase Client-Side SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Core Setup ---
        let app, db, auth;
        const APP_ID = 'afripulse-ai-digest';
        
        try {
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authenticate (required for client-side Firestore access)
            const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (authToken) {
                signInWithCustomToken(auth, authToken).catch(e => {
                    console.error("Auth token sign-in failed, attempting anonymous.", e);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }

            fetchLatestDigest();
            setupSubscriptionForm();

        } catch (e) {
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('error-message').textContent = `Initialization Error: ${e.message}`;
            console.error("Firebase initialization error:", e);
        }
        
        // --- Digest Fetching ---

        async function fetchLatestDigest() {
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('error-message');
            const storiesContainer = document.getElementById('stories-container');
            
            loadingSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            storiesContainer.innerHTML = '';

            try {
                // 1. Get the latest pointer document ID
                const latestDocRef = doc(db, `artifacts/${APP_ID}/public/data/digests`, 'latest');
                const latestSnap = await getDoc(latestDocRef);

                if (!latestSnap.exists()) {
                    throw new Error("No 'latest' digest pointer found. The Cloud Function has not run yet.");
                }

                const latestId = latestSnap.data().latest_digest_id;

                // 2. Fetch the actual digest document
                const digestDocRef = doc(db, `artifacts/${APP_ID}/public/data/digests`, latestId);
                const digestSnap = await getDoc(digestDocRef);

                if (!digestSnap.exists()) {
                    throw new Error(`Digest document ${latestId} not found.`);
                }

                renderDigest(digestSnap.data());

            } catch (e) {
                console.error("Failed to fetch digest:", e);
                errorMessage.textContent = `Error: ${e.message}. Please check your Cloud Function deployment and Firestore rules.`;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function renderDigest(data) {
            const container = document.getElementById('stories-container');
            const dateStr = data.published_date;
            
            document.getElementById('digest-title').textContent = `AfriPulse Weekly Digest`;
            document.getElementById('digest-date').textContent = `Published: ${dateStr} (Generated ${new Date(data.timestamp).toLocaleTimeString()})`;

            if (data.top_stories.length === 0) {
                container.innerHTML = `<p class="text-gray-500 p-6 bg-gray-100 rounded-xl text-center">The digest is currently empty. Check back next week!</p>`;
                return;
            }

            data.top_stories.forEach(story => {
                const storyElement = `
                    <div class="card bg-white p-6 rounded-xl border-l-4 border-indigo-500 shadow-md">
                        <span class="text-base font-bold text-indigo-600">#${story.rank}</span>
                        <h3 class="text-2xl font-extrabold text-gray-900 mt-1">${story.title}</h3>
                        <p class="text-gray-700 mt-4 leading-relaxed">${story.summary}</p>
                        <div class="mt-5 pt-3 border-t border-gray-100 flex justify-between items-center text-sm text-gray-500">
                            <span class="font-medium">Source: ${story.source}</span>
                            <a href="${story.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center transition duration-150">
                                Read Full Story 
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                        </div>
                    </div>
                `;
                container.innerHTML += storyElement;
            });
        }

        // --- Subscription Handling ---

        function setupSubscriptionForm() {
            const form = document.getElementById('subscribe-form');
            const emailInput = document.getElementById('email-input');
            const messageBox = document.getElementById('message-box');
            const subscribeButton = document.getElementById('subscribe-button');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = emailInput.value.trim().toLowerCase();
                if (!email) return;

                messageBox.className = 'mt-3 text-sm text-center font-medium text-gray-600';
                messageBox.textContent = 'Subscribing...';
                subscribeButton.disabled = true;

                try {
                    // Path: artifacts/{appId}/public/data/subscribers/{email}
                    const subscriberRef = doc(db, `artifacts/${APP_ID}/public/data/subscribers`, email);

                    await setDoc(subscriberRef, {
                        email: email,
                        status: 'active',
                        subscribed_at: new Date().toISOString()
                    });
                    
                    messageBox.className = 'mt-3 text-sm text-center font-bold text-green-600';
                    messageBox.textContent = 'üéâ Success! Your subscription has been added!';
                    emailInput.value = ''; // Clear input

                } catch (error) {
                    console.error("Subscription failed:", error);
                    messageBox.className = 'mt-3 text-sm text-center font-bold text-red-600';
                    messageBox.textContent = '‚ùå Subscription failed. Please check your network or try again later.';
                } finally {
                    subscribeButton.disabled = false;
                }
            });
        }

    </script>
</body>
</html>
